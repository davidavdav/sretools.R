#!/usr/bin/perl -w
## add target/non-target infrmation to a NIST SRE submission file. 
# (c) 2008 David A. van Leeuwen, TNO, ICSI

## This program is free software; you can redistribute it and/or
## modify it under the terms of the GNU General Public License as
## published by the Free Software Foundation, version 2 of the
## License. 

## This is a temporary hack.  We would like to include the relevant SRE key
## information in data frames that go with the det.R package. 

## Needs datafiles for 2005, 2006, 2008 eval

use Getopt::Long;
$warn=0;
$addlang=0;
GetOptions("warn!" => \$warn,
	   "lang!" => \$addlang);

## 2005, 2006
open IN, "cat key/200*.key |";
while (<IN>) {
    chomp;
    ($pin, $name, $lang)=split;
    $pin{$name}=$pin;
    $lang{$name}=$lang if defined $lang;
}

## 2008
open IN, "cat key/NIST_SRE08_short2-short3.trial.key |" or die;
while (<IN>) {
    ($model, $sph, $chan, $tar)=split ",";
    $key="$model-$sph-$chan";
    $target{$key}=($tar =~ "^tar") ? "T" : "F";
}

$lm=$lt="";
$nundef=0;
$pid=open OUT, "| sort -k5 -k6 -k7"; select OUT;
while (<>) {
    chomp;
    ($mcond, $adapt, $tcond, $sex, $model, $test, $chan, $dec, $score)=split;
    $model =~ tr/A-Z/a-z/;
    $chan =~ tr/A-Z/a-z/;
    if ($model =~ /(\d+)_ch\d\d$/) { # interview experiment
	$mid=$1; 
	($tid) = $test =~ /(\d+)_CH\d\d$/; 
	$target = $mid eq $tid ? "T" : "F";
    } elsif (defined ($target=$target{"$model-$test-$chan"})) {
	0;
    } elsif (! defined ($p1=$pin{$model}) || !defined ($p2=$pin{"$test-$chan"})) {
	$nundef++;
	if ($warn) {
	    warn "$model:".defined($pin{$model}).
		" $test-$chan:".defined($pin{"$test-$chan"});
	    next;
	}
    } else {
	$target = $p1 eq $p2 ? "T" : "F";
    }
    if ($addlang) {
	if ($model =~ /ch(\d\d)$/) {
	    $lm=$1;
	    ($lt)= $test=~/CH(\d\d)$/;
	} else {
	    $lm=defined $lang{$model} ? $lang{$model} : "unk";
	    $lt=defined $lang{"$test-$chan"} ? $lang{"$test-$chan"} : "unk";
	}
    }
    if (!defined $target) {
	warn "Missing target for $model-$test-$chan\n" if $warn;
    } else {
	print join(" ", $mcond, $adapt, $tcond, $sex, $model, $test, $chan, 
		   $dec, $score, $target, $lm, $lt), "\n";
    }
}
close OUT;
waitpid $pid, 0;

if ($nundef) {
    printf STDERR "$nundef trials ignored because missing from key\n";
}


